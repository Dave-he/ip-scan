services:
  ip-scanner:
    build: .
    container_name: ip-scanner
    volumes:
      - ./data:/data
    network_mode: host
    environment:
      - RUST_LOG=info
      - SCAN_PORTS=21,22,23,25,53,80,110,143,443,445,3306,3389,5432,6379,8080,8443,9200,27017
      - SCAN_TIMEOUT=500
      - SCAN_CONCURRENCY=100
      - SCAN_DATABASE=/data/scan_results.db
      - SCAN_LOOP_MODE=true
      - SCAN_IPV4=true
      - SCAN_IPV6=false
      - SCAN_VERBOSE=false
      - SCAN_ONLY_OPEN=true
      - SCAN_SKIP_PRIVATE=true
    restart: unless-stopped
    networks:
      - ip-scan-network
    # 资源限制
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # API 服务 - 提供 REST API 接口
  api:
    build: .
    container_name: ip-scan-api
    command: 
      - "./ip-scan"
      - "--api-only"         # 只启动 API
      - "--api-port"         # API 端口
      - "8080"
      - "--api-host"         # 绑定地址
      - "0.0.0.0"
      - "--swagger-ui"       # 启用 Swagger UI
      - "--database"         # 数据库路径（与扫描器共享）
      - "/data/scan_results.db"
    ports:
      - "8080:8080"          # 暴露 API 端口
    volumes:
      - ./data:/data         # 挂载数据目录（与扫描器共享）
    depends_on:
      - scanner
    restart: unless-stopped
    networks:
      - ip-scan-network
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/stats"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # 资源限制
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Nginx 反向代理 (可选)
  nginx:
    image: nginx:alpine
    container_name: ip-scan-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - ip-scan-network

networks:
  ip-scan-network:
    driver: bridge

volumes:
  data:
    driver: local